# Kubernetes ServiceAccount with Workload Identity annotation
# This links the Kubernetes ServiceAccount to a GCP ServiceAccount
# Pods using this KSA will authenticate as the GCP SA via Workload Identity

apiVersion: v1
kind: ServiceAccount
metadata:
  name: demo-app-ksa
  namespace: default
  annotations:
    # CRITICAL: This annotation enables Workload Identity
    # Format: GCP_SA_NAME@PROJECT_ID.iam.gserviceaccount.com
    # Replace with your actual GCP service account email
    iam.gke.io/gcp-service-account: demo-app-sa@my-project-dev.iam.gserviceaccount.com

  labels:
    app: demo-app
    environment: development

---
# ServiceAccount for different environment (production)
# Note: Uses different GCP SA (demo-app-sa-prod)

apiVersion: v1
kind: ServiceAccount
metadata:
  name: demo-app-ksa
  namespace: production
  annotations:
    iam.gke.io/gcp-service-account: demo-app-sa@my-project-prod.iam.gserviceaccount.com
  labels:
    app: demo-app
    environment: production

---
# IMPORTANT: After creating the Kubernetes ServiceAccount,
# you must establish the Workload Identity binding on the GCP side:
#
# gcloud iam service-accounts add-iam-policy-binding \
#   demo-app-sa@my-project-dev.iam.gserviceaccount.com \
#   --project=my-project-dev \
#   --role=roles/iam.workloadIdentityUser \
#   --member="serviceAccount:my-project-dev.svc.id.goog[default/demo-app-ksa]"
#
# Format: serviceAccount:PROJECT_ID.svc.id.goog[NAMESPACE/KSA_NAME]
#
# This grants the Kubernetes ServiceAccount permission to impersonate the GCP ServiceAccount
