# SecretProviderClass - Defines which secrets to fetch from Google Secret Manager
# This resource is read by the Secrets Store CSI driver when pods mount the volume
#
# IMPORTANT: Replace PROJECT_NUMBER with your actual GCP project number
# Get it with: gcloud projects describe PROJECT_ID --format="value(projectNumber)"

apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: demo-app-secrets
  namespace: default
spec:
  provider: gcp  # Use GCP provider for Secret Manager

  parameters:
    # List of secrets to fetch from Secret Manager
    # Each secret will be mounted as a file in the pod
    secrets: |
      # Service account key for Cloud Storage access
      - resourceName: "projects/PROJECT_NUMBER/secrets/demo-app-sa-key/versions/latest"
        path: "credentials.json"

      # API key for third-party service
      - resourceName: "projects/PROJECT_NUMBER/secrets/demo-app-api-key/versions/latest"
        path: "api-key.txt"

      # Database connection string
      - resourceName: "projects/PROJECT_NUMBER/secrets/demo-app-db-url/versions/latest"
        path: "database-url.txt"

  # Optional: Sync secrets to native Kubernetes Secret
  # Use this only if you need environment variable access
  # File-based access is more secure (secrets not in etcd)
  secretObjects:
  - secretName: demo-app-secret  # Name of K8s Secret to create
    type: Opaque
    data:
    # Map secret files to keys in K8s Secret
    - key: sa-key
      objectName: "credentials.json"  # Must match path above
    - key: api-key
      objectName: "api-key.txt"
    - key: db-url
      objectName: "database-url.txt"

---
# Alternative: Multiple SecretProviderClass for different secret groups
# This pattern is useful when different pods need different subsets of secrets

apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: demo-app-storage-secrets
  namespace: default
spec:
  provider: gcp
  parameters:
    secrets: |
      - resourceName: "projects/PROJECT_NUMBER/secrets/demo-app-sa-key/versions/latest"
        path: "credentials.json"

---
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: demo-app-api-secrets
  namespace: default
spec:
  provider: gcp
  parameters:
    secrets: |
      - resourceName: "projects/PROJECT_NUMBER/secrets/demo-app-api-key/versions/latest"
        path: "api-key.txt"
      - resourceName: "projects/PROJECT_NUMBER/secrets/stripe-api-key/versions/latest"
        path: "stripe-key.txt"

---
# Example: Using specific version instead of "latest"
# Useful for testing new secret versions in staging before production

apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: demo-app-secrets-staging
  namespace: staging
spec:
  provider: gcp
  parameters:
    secrets: |
      # Pin to specific version for testing
      - resourceName: "projects/PROJECT_NUMBER/secrets/demo-app-sa-key/versions/3"
        path: "credentials.json"

      # Use latest for other secrets
      - resourceName: "projects/PROJECT_NUMBER/secrets/demo-app-api-key/versions/latest"
        path: "api-key.txt"
